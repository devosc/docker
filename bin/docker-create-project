#!/usr/bin/env bash

# creates project in docker www directory (experimental).

project_dir="$( cd "$(dirname "$0")/../www" ; pwd -P )"

[ -d $project_dir/html ] && document_root="$project_dir/html" || document_root="$project_dir/public"

function reset_project_dir()
{
    if [ -d $project_dir ]; then

        cd $project_dir

        find . -type f -delete
        find . -type l -delete
        find . -type d -name '*' -delete

    fi

    cd $project_dir/..
}

if [ "wordpress" = "$1" ]; then
    reset_project_dir

    curl -O https://wordpress.org/latest.tar.gz
    tar -xzvf latest.tar.gz --directory $project_dir
    rm -rf $document_root
    mv $project_dir/wordpress $document_root
    rm latest.tar.gz

    cp favicon.ico "$document_root/favicon.ico"

    proxy="\\
\\
// https://codex.wordpress.org/Administration_Over_SSL \\
define('FORCE_SSL_ADMIN', true); \\
\\
if ((\$_SERVER['HTTP_X_FORWARDED_PROTO'] ?? null) == 'https')\\
    \$_SERVER['HTTPS']='on';"

    sed -i.bak "s#define('WP_DEBUG', false);#define('WP_DEBUG', false);$proxy#g" "$document_root/wp-config-sample.php"
    rm "$document_root/wp-config-sample.php.bak"

    echo "Create default database? [no/yes]"

    read create_database

    if [ "$create_database" = "yes" ]; then
        docker exec mariadb sh -c 'mysqladmin -uroot -psecret drop wordpress --force'
        docker exec mariadb sh -c 'mysqladmin -uroot -psecret create wordpress'
        echo "host: mariadb database: wordpress user: root password: secret"
    fi

elif [ "multisite-convert" = "$1" ]; then

    docker-wp core multisite-convert --subdomains

    cookie_domain="\\
\\
define('COOKIE_DOMAIN', false);"

    sed -i.bak "s#define('WP_DEBUG', false);#define('WP_DEBUG', false);$cookie_domain#g" "$document_root/wp-config.php"
    rm "$document_root/wp-config.php.bak"

    cat << 'EOF' > $document_root/.htaccess
<IfModule mod_rewrite.c>
    RewriteEngine On
    RewriteBase /
    RewriteRule ^index\.php$ - [L]

    # add a trailing slash to /wp-admin
    RewriteRule ^wp-admin$ wp-admin/ [R=301,L]

    RewriteCond %{REQUEST_FILENAME} -f [OR]
    RewriteCond %{REQUEST_FILENAME} -d
    RewriteRule ^ - [L]
    RewriteRule ^(wp-(content|admin|includes).*) $1 [L]
    RewriteRule ^(.*\.php)$ $1 [L]
    RewriteRule . index.php [L]
</IfModule>
EOF

elif [ "laravel" = "$1" ]; then
    reset_project_dir
    docker-composer create-project --prefer-dist laravel/laravel .
elif [ "symfony" = "$1" ]; then
    reset_project_dir
    docker-composer create-project --prefer-dist symfony/website-skeleton .
    cp favicon.ico "$document_root/favicon.ico"
elif [ "phpinfo" = "$1" ]; then
    reset_project_dir
    mkdir -p $document_root
    cp favicon.ico "$document_root/favicon.ico"
    cat <<EOT >> $document_root/index.php
<?php

phpinfo();
EOT
elif [ "mvc5" = "$1" ]; then
    reset_project_dir
    docker-composer create-project mvc5/mvc5-application .
else
    echo "Project not found. Choose from laravel, mvc5, multisite-convert, phpinfo, symfony, wordpress"
fi

echo "Project URL: https://docker-project"
