#!/usr/bin/env bash

source docker-build-env

if [ -z "$1" ] || [ "up" = "$1" ] || [ "down" = "$1" ]; then
    cd "$( cd "$(dirname "$0")" ; pwd -P )/.."
    ./services "$@"
else
    name="$( basename "$1" )"
    src="$( dirname "${BASH_SOURCE[0]}" )/../service/$name"

    if [ -d "$src" ]; then
        file="$src/docker-compose.yml"
    elif [ -f "$src.yml" ]; then
        file="$src.yml"
    else
        echo "Service: $name not found"
        exit 1
    fi

    if [ "down" = "$2" ]; then
        # remove images
        rmi=""
        if [ "--remove-images" = "$3" ]; then
            images=$(docker-compose --file $(pwd)/docker-compose.yml images -q)
            if [ "$images" != "" ]; then
                rmi="--rmi local"
            else
                echo "No images"
            fi
            shift
        fi

        docker-compose --project-name $name --file $file down --remove-orphans $rmi
    else
        # build images before starting containers
        build=""
        if [ "--build" = "$3" ]; then
            build="$3";
        fi

        docker-compose --project-name $name --file $file up -d $build
    fi
fi
