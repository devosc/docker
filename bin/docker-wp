#!/usr/bin/env bash

function multisite_convert()
{
    directory="$1"
    document_root="${directory}/html"

    docker-wp core multisite-convert --subdomains

    if [[ $? = 0 ]]; then
        cookie_domain="\\
\\
define('COOKIE_DOMAIN', false);"

        sed -i.bak "s#define('WP_DEBUG', false);#define('WP_DEBUG', false);$cookie_domain#g" "${document_root}/wp-config.php"
        rm "${document_root}/wp-config.php.bak"

        cat << 'EOF' > "${document_root}/.htaccess"
    <IfModule mod_rewrite.c>
        RewriteEngine On
        RewriteBase /
        RewriteRule ^index\.php$ - [L]

        # add a trailing slash to /wp-admin
        RewriteRule ^wp-admin$ wp-admin/ [R=301,L]

        RewriteCond %{REQUEST_FILENAME} -f [OR]
        RewriteCond %{REQUEST_FILENAME} -d
        RewriteRule ^ - [L]
        RewriteRule ^(wp-(content|admin|includes).*) $1 [L]
        RewriteRule ^(.*\.php)$ $1 [L]
        RewriteRule . index.php [L]
    </IfModule>
EOF

    echo "Updated wp-config.php and .htaccess files.

After creating a new site in wp-admin, the following steps are required:

    - Add site to your /etc/hosts file.
        e.g. 127.0.0.1 site1.docker-project

    - Add site to the traefik.frontend.rule in the docker compose file.
        e.g. traefik.frontend.rule=Host:docker-project, site1.docker-project

    - Build container
        docker-up --build
"
    else
        echo "
An error occurred. Check the following:
    - Multisite may already be installed.
    - WP-CLI must be enabled in the docker compose file."
        exit 1
    fi
}

if [[ "$1" = "multisite-convert" ]]; then
    multisite_convert ${PWD}
else
    docker-app wp "$@"
fi
