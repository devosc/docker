#!/usr/bin/env bash

source docker-build-env

directory="$(pwd)"
enable=true
idekey="DEBUG"
profiler=""
profiler_output_dir="/tmp"
session=""

usage()
{
    echo "Usage: docker-xdebug on|off [OPTIONS]
Options:
    --project-directory PATH            Alternative working directory, default is current directory.
    --session-start                     Start remote debugging session.
    --sessition-stop                    Stop remote debugging session.
    --idekey SESSION_NAME               E.g. project-name, default is DEBUG.
    --profiler-off                      Turn profiler on.
    --profiler-on                       Turn profiler off.
    --profiler-output-directory PATH    E.g. /var/www/tmp, default is /tmp.
"

}

while [ "$1" != "" ]; do
    case $1 in
        on )                    enable=true
                                ;;
        off )                   enable=false
                                ;;
        --idekey )              idekey="$2"
                                shift
                                ;;
        --profiler-on )         profiler=true
                                ;;
        --profiler-off )        profiler=false
                                ;;
        --profiler-output-dir ) profiler_output_dir="$2"
                                shift
                                ;;
        --project-directory )   directory="$2"
                                shift
                                ;;
        --session-start )       session=true
                                ;;
        --session-stop )        session=false
                                ;;
        -h | --help )           usage
                                exit
                                ;;
        * )                     usage
                                exit 1
                                ;;
    esac

    shift
done

if [ "$enable" = "true" ]; then
    docker-root --project-directory "$directory" sed -i 's/;zend_extension=/zend_extension=/g' /usr/local/etc/php/conf.d/docker-php-ext-xdebug.ini

    profiler_msg=""
    profiler_settings=""
    remote_msg=""
    session_settings=""

    if [ "$session" = "true" ]; then
        #https://stackoverflow.com/a/13322549
        ip=($(ifconfig | sed -En 's/127.0.0.1//;s/.*inet (addr:)?(([0-9]*\.){3}[0-9]*).*/\2/p'))

        session_settings="
xdebug.remote_enable=1
xdebug.remote_autostart=1
xdebug.idekey=${idekey}
xdebug.remote_host=${ip[@]: -1}
xdebug.remote_port=9000
"
        docker-root --project-directory "$directory" bash -c "echo \"${session_settings}\" > /usr/local/etc/php/conf.d/xdebug-remote.ini"

        remote_msg="Remote debugging session has started:"

    elif [ "$session" = "false" ]; then

        docker-root --project-directory "$directory" rm -f /usr/local/etc/php/conf.d/xdebug-remote.ini

        remote_msg="Remote debugging session has stopped."

    fi

    if [ "$profiler" = "true" ]; then
        profiler_settings="
xdebug.profiler_enable=1
xdebug.profiler_output_dir=${profiler_output_dir}
"

        docker-root --project-directory "$directory" bash -c "echo \"${profiler_settings}\" > /usr/local/etc/php/conf.d/xdebug-profiler.ini"

        profiler_msg="Profiler started:"

    elif [ "$profiler" = "false" ]; then

        docker-root --project-directory "$directory" rm -f /usr/local/etc/php/conf.d/xdebug-profiler.ini

        profiler_msg="Profiler stopped."

    fi

    docker-root --project-directory "$directory" apache2ctl -k graceful

    echo "Xdebug has been turned on."

    if [ -n "${remote_msg}" ]; then
        echo "${remote_msg}"
    fi

    if [ -n "${session_settings}" ]; then
        echo "${session_settings}"
    fi

    if [ -n "${profiler_msg}" ]; then
        echo "${profiler_msg}"
    fi

    if [ -n "${profiler_settings}" ]; then
        echo "${profiler_settings}"
    fi

else

    docker-root --project-directory "$directory" sed -i 's/^zend_extension=/;zend_extension=/g' /usr/local/etc/php/conf.d/docker-php-ext-xdebug.ini
    docker-root --project-directory "$directory" rm -f /usr/local/etc/php/conf.d/xdebug-remote.ini
    docker-root --project-directory "$directory" apache2ctl -k graceful

    echo "Xdebug has been turned off."

fi
